# í™ˆí˜ì´ì§€ ì»¨íŠ¸ë¡¤ëŸ¬ - íŠ¹í—ˆ ë²ˆì—­ ì„œë¹„ìŠ¤ ëœë”©í˜ì´ì§€
class HomeController < ApplicationController
  # ëœë”©í˜ì´ì§€ ë©”ì¸ ì•¡ì…˜
  # GET /
  def index
    # ëœë”©í˜ì´ì§€ì— í‘œì‹œí•  í†µê³„ ë°ì´í„° (ë§ˆì¼€íŒ…ìš© ê³¼ì¥ëœ ìˆ˜ì¹˜)
    @stats = {
      accuracy_rate: "99.9%",           # ë²ˆì—­ ì •í™•ë„
      translation_count: "1,000,000+",  # ì´ ë²ˆì—­ ê±´ìˆ˜
      customer_satisfaction: "99.8%",   # ê³ ê° ë§Œì¡±ë„
      glossary_terms: "100,000+",       # ì „ë¬¸ ìš©ì–´ ìˆ˜
      processing_time_reduction: "90%", # ì²˜ë¦¬ ì‹œê°„ ë‹¨ì¶•
      security_level: "êµ°ì‚¬ê¸‰"           # ë³´ì•ˆ ìˆ˜ì¤€
    }

    # ê³ ê° í›„ê¸° ë°ì´í„° (ê°€ìƒì˜ í›„ê¸°)
    @testimonials = [
      {
        name: "ê¹€â—‹â—‹ ë³€ë¦¬ì‚¬",
        company: "â—‹â—‹íŠ¹í—ˆë²•ë¬´ë²•ì¸",
        comment: "íŠ¹í—ˆ ë²ˆì—­ ì‹œê°„ì´ 90% ë‹¨ì¶•ë˜ì—ˆìŠµë‹ˆë‹¤. AI ë©€í‹° ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œì´ ì •ë§ ë†€ëë„¤ìš”!",
        rating: 5
      },
      {
        name: "ë°•â—‹â—‹ ì—°êµ¬ì›",
        company: "â—‹â—‹ì „ì R&Dì„¼í„°",
        comment: "ë²ˆì—­ í’ˆì§ˆì´ ì „ë¬¸ ë²ˆì—­ì‚¬ ìˆ˜ì¤€ì…ë‹ˆë‹¤. ê¸°ìˆ  ìš©ì–´ ë²ˆì—­ì´ íŠ¹íˆ ì •í™•í•´ìš”.",
        rating: 5
      },
      {
        name: "ì´â—‹â—‹ IPíŒ€ì¥",
        company: "â—‹â—‹ë°”ì´ì˜¤",
        comment: "ë³´ì•ˆì´ ì² ì €í•´ì„œ ì•ˆì‹¬í•˜ê³  ì‚¬ìš©í•©ë‹ˆë‹¤. ì¤‘ìš”í•œ íŠ¹í—ˆ ë¬¸ì„œë„ ë¯¿ê³  ë§¡ê¸¸ ìˆ˜ ìˆì–´ìš”.",
        rating: 5
      }
    ]

    # FAQ ë°ì´í„°
    @faqs = [
      {
        question: "ë²ˆì—­ ì •í™•ë„ëŠ” ì–¼ë§ˆë‚˜ ë˜ë‚˜ìš”?",
        answer: "AI ë©€í‹° ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œìœ¼ë¡œ 99.9% ì •í™•ë„ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤. ê° ì „ë¬¸ ë¶„ì•¼ë³„ íŠ¹í™” ì—ì´ì „íŠ¸ê°€ ë™ì‹œì— ì‘ì—…í•˜ì—¬ ì™„ë²½í•œ ë²ˆì—­ í’ˆì§ˆì„ ì œê³µí•©ë‹ˆë‹¤."
      },
      {
        question: "ë³´ì•ˆì€ ì–´ë–»ê²Œ ë³´ì¥ë˜ë‚˜ìš”?",
        answer: "êµ°ì‚¬ê¸‰ ì•”í˜¸í™” ê¸°ìˆ ê³¼ ISO 27001 ì¸ì¦ ìˆ˜ì¤€ì˜ ë³´ì•ˆ ì¸í”„ë¼ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì¢…ë‹¨ê°„ ì•”í˜¸í™”(E2E)ê°€ ì ìš©ë˜ë©°, ë²ˆì—­ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤."
      },
      {
        question: "ì–´ë–¤ ì–¸ì–´ë¥¼ ì§€ì›í•˜ë‚˜ìš”?",
        answer: "í•œêµ­ì–´, ì˜ì–´, ì¼ë³¸ì–´, ì¤‘êµ­ì–´ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. íŠ¹í—ˆ ë¬¸ì„œì— íŠ¹í™”ëœ ì „ë¬¸ ìš©ì–´ì§‘ì„ ë°”íƒ•ìœ¼ë¡œ ì •í™•í•œ ë²ˆì—­ì„ ì œê³µí•©ë‹ˆë‹¤."
      },
      {
        question: "ë¬´ë£Œ ì²´í—˜ì€ ì–´ë–»ê²Œ ì´ìš©í•˜ë‚˜ìš”?",
        answer: "íšŒì›ê°€ì… í›„ ë§¤ì›” 5í˜ì´ì§€ê¹Œì§€ ë¬´ë£Œë¡œ ë²ˆì—­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹ ìš©ì¹´ë“œ ë“±ë¡ ì—†ì´ë„ ë°”ë¡œ ì²´í—˜ ê°€ëŠ¥í•©ë‹ˆë‹¤."
      },
      {
        question: "ë²ˆì—­ ì‹œê°„ì€ ì–¼ë§ˆë‚˜ ê±¸ë¦¬ë‚˜ìš”?",
        answer: "ì¼ë°˜ì ìœ¼ë¡œ A4 1í˜ì´ì§€ë‹¹ 2-3ë¶„ ë‚´ì— ë²ˆì—­ì´ ì™„ë£Œë©ë‹ˆë‹¤. Premium íšŒì›ì€ ìš°ì„  ì²˜ë¦¬ë¡œ ë”ìš± ë¹ ë¥¸ ë²ˆì—­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."
      }
    ]

    # ê°€ê²© ì •ì±… ë°ì´í„°
    @pricing_plans = [
      {
        name: "Free",
        price: "ë¬´ë£Œ",
        period: "",
        popular: false,
        # Free í”Œëœ ì¹´ë“œ í‘œê¸° ë¬¸êµ¬ (ìš”ì²­ì— ë”°ë¼ ì—…ë°ì´íŠ¸)
        # - ì²« 100í˜ì´ì§€
        # - 3ì‹œê°„ ì´ë‚´ ë‚©í’ˆ
        # - ì†Œì§„ëœ ë¬´ë£Œ í˜ì´ì§€ ìˆ˜ê°€ ë„˜ì–´ê°€ë©´ ì¶”ê°€ ê²°ì œ í›„ ê³„ì† ì‚¬ìš© ê°€ëŠ¥.
        # - ë¬´ì œí•œ ìˆ˜ì •.
        features: [
          "ì²« 100í˜ì´ì§€",
          "3ì‹œê°„ ì´ë‚´ ë‚©í’ˆ",
          "ì†Œì§„ëœ ë¬´ë£Œ í˜ì´ì§€ ìˆ˜ê°€ ë„˜ì–´ê°€ë©´ ì¶”ê°€ ê²°ì œ í›„ ê³„ì† ì‚¬ìš© ê°€ëŠ¥.",
          "ë¬´ì œí•œ ìˆ˜ì •."
        ],
        cta_text: "ì‹œì‘í•˜ê¸°",
        cta_class: "btn-outline"
      },
      {
        # ì¼ë°˜ ìœ ë£Œ ë²ˆì—­ í”Œëœ (ê¸°ì¡´ Premium í”Œëœ ë¦¬ë„¤ì´ë°)
        name: "ì¼ë°˜ ë²ˆì—­",
        # ê°€ê²© í‘œê¸°: 9,900ì› / 1í˜ì´ì§€(400ë‹¨ì–´)
        price: "9,900ì›",
        period: "/1í˜ì´ì§€(400ë‹¨ì–´)",
        # ì¶”ì²œ ë°°ì§€ ë¹„ë…¸ì¶œì„ ìœ„í•´ popular ë¹„í™œì„±í™”
        popular: false,
        # í˜œíƒ ë¬¸êµ¬: ìš”ì²­ ì‚¬í•­ ë°˜ì˜
        features: [
          "ì²« ê²°ì œì•¡ ë§Œí¼ ë¬´ë£Œ ì œê³µ 1+1",
          "3ì‹œê°„ ì´ë‚´ ë‚©í’ˆ(ìš°ì„  ì²˜ë¦¬)",
          "ë¬´ì œí•œ ìˆ˜ì •."
        ],
        cta_text: "ì‹œì‘í•˜ê¸°",
        cta_class: "btn-primary"
      },
      {
        # ê¸´ê¸‰ ë²ˆì—­ í”Œëœ (ê¸°ì¡´ Enterprise í”Œëœ ë¦¬ë„¤ì´ë°)
        name: "ê¸´ê¸‰ ë²ˆì—­",
        price: "15,000ì›",
        period: "/1í˜ì´ì§€(400ë‹¨ì–´)",
        popular: false,
        features: [
          "1ì‹œê°„ ì´ë‚´ ë‚©í’ˆ(ìµœìš°ì„  ì²˜ë¦¬)",
          "ë¬´ì œí•œ ìˆ˜ì •."
        ],
        cta_text: "ë¬¸ì˜í•˜ê¸°",
        cta_class: "btn-outline"
      }
    ]
  end

  # ê°€ê²© ì •ì±… í˜ì´ì§€
  # GET /pricing
  # í—¤ë”/í‘¸í„°ëŠ” ë·°ì—ì„œ ë™ì¼ ë§ˆí¬ì—…ì„ í¬í•¨í•˜ì—¬ ìœ ì§€í•©ë‹ˆë‹¤.
  def pricing
    # ë©”ì¸(index)ê³¼ ë™ì¼í•œ ê°€ê²© ì •ì±… ë°ì´í„° ì‚¬ìš©
    @pricing_plans = [
      {
        name: "Free",
        price: "ë¬´ë£Œ",
        period: "/100í˜ì´ì§€",
        popular: false,
        # Free í”Œëœ ì¹´ë“œ í‘œê¸° ë¬¸êµ¬ (ìš”ì²­ì— ë”°ë¼ ì—…ë°ì´íŠ¸)
        # - ì²« 100í˜ì´ì§€
        # - 3ì‹œê°„ ì´ë‚´ ë‚©í’ˆ
        # - ë¬´ì œí•œ ìˆ˜ì •.
        features: [
          "ì²« 100í˜ì´ì§€",
          "3ì‹œê°„ ì´ë‚´ ë‚©í’ˆ",
          "ë¬´ì œí•œ ìˆ˜ì •."
        ],
        cta_text: "ì‹œì‘í•˜ê¸°",
        cta_class: "btn-outline"
      },
      {
        # ì¼ë°˜ ìœ ë£Œ ë²ˆì—­ í”Œëœ (ê¸°ì¡´ Premium í”Œëœ)
        name: "ì¼ë°˜ ë²ˆì—­",
        price: "9,900ì›",
        period: "/1í˜ì´ì§€",
        popular: false,
        features: [
          "ì²« ê²°ì œì•¡ ë§Œí¼ 1+1ë¬´ë£Œ ì œê³µ",
          "3ì‹œê°„ ì´ë‚´ ë‚©í’ˆ(ìš°ì„  ì²˜ë¦¬)",
          "ë¬´ì œí•œ ìˆ˜ì •."
        ],
        cta_text: "ì‹œì‘í•˜ê¸°",
        cta_class: "btn-primary"
      },
      {
        # ê¸´ê¸‰ ë²ˆì—­ í”Œëœ (ê¸°ì¡´ Enterprise í”Œëœ ë¦¬ë„¤ì´ë°)
        name: "ê¸´ê¸‰ ë²ˆì—­",
        price: "15,000ì›",
        period: "/1í˜ì´ì§€",
        popular: false,
        features: [
          "1ì‹œê°„ ì´ë‚´ ë‚©í’ˆ(ìµœìš°ì„  ì²˜ë¦¬)",
          "ê¸´ê¸‰ ìœ ì„  ëŒ€ì‘",
          "ë¬´ì œí•œ ìˆ˜ì •."
        ],
        cta_text: "ë¬¸ì˜í•˜ê¸°",
        cta_class: "btn-outline"
      }
    ]
  end

  # ë°ëª¨ ë²ˆì—­ ê¸°ëŠ¥ (ê°„ë‹¨í•œ ì˜ˆì‹œ)
  # POST /demo_translate
  def demo_translate
    input_text = params[:text]&.strip

    if input_text.blank?
      render json: { error: "ë²ˆì—­í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." }, status: 400
      return
    end

    # ì‹¤ì œë¡œëŠ” ë²ˆì—­ APIë¥¼ í˜¸ì¶œí•˜ì§€ë§Œ, ë°ëª¨ìš©ìœ¼ë¡œ ê°„ë‹¨í•œ ì˜ˆì‹œ ì‘ë‹µ
    demo_translations = {
      "íŠ¹í—ˆ ì¶œì›" => "Patent Application",
      "ë°œëª…ì˜ ëª…ì¹­" => "Title of Invention",
      "ê¸°ìˆ ë¶„ì•¼" => "Technical Field",
      "ë°°ê²½ê¸°ìˆ " => "Background Art",
      "ë°œëª…ì˜ ë‚´ìš©" => "Description of Invention",
      "ì‹¤ì‹œì˜ˆ" => "Embodiments",
      "ì²­êµ¬ë²”ìœ„" => "Claims"
    }
    
    # ê°„ë‹¨í•œ í‚¤ì›Œë“œ ë§¤ì¹­ìœ¼ë¡œ ë°ëª¨ ë²ˆì—­ ì œê³µ
    translated_text = input_text
    demo_translations.each do |korean, english|
      translated_text = translated_text.gsub(korean, english)
    end
    
    # ë²ˆì—­ë˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ ë©”ì‹œì§€
    if translated_text == input_text
      translated_text = "Translation result will appear here... (Demo version)"
    end
    
    render json: {
      original: input_text,
      translated: translated_text,
      message: "ğŸ’¡ ì‹¤ì œ ë²ˆì—­ì€ íšŒì›ê°€ì… í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."
    }
  end

  # ë²ˆì—­ ìš”ì²­ í¼ í˜ì´ì§€
  # GET /contact
  def contact
    # ë²ˆì—­ ìš”ì²­ í¼ í˜ì´ì§€ ë Œë”ë§
    # ë²ˆì—­ ìœ í˜•: ì¼ë°˜ ë²ˆì—­, ê¸´ê¸‰ ë²ˆì—­, ë¬¸ì˜
    @translation_types = [
      { value: 'general', label: 'ì¼ë°˜ ë²ˆì—­', description: '3ì‹œê°„ ì´ë‚´ ë‚©í’ˆ' },
      { value: 'urgent', label: 'ê¸´ê¸‰ ë²ˆì—­', description: '1ì‹œê°„ ì´ë‚´ ë‚©í’ˆ (ë°œì†¡ í›„ 10ë¶„ ì´ë‚´ ì—°ë½)' },
      { value: 'inquiry', label: 'ë¬¸ì˜', description: 'ë²ˆì—­ ê´€ë ¨ ìƒë‹´ ë° ë¬¸ì˜' }
    ]
  end

  # ë²ˆì—­ ìš”ì²­ ë©”ì¼ ë°œì†¡
  # POST /send_translation_request
  def send_translation_request
    # í•„ìˆ˜ íŒŒë¼ë¯¸í„° ê²€ì¦
    # 2025-08-21: ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ì „í™”ë²ˆí˜¸ëŠ” ì„ íƒ í•­ëª©ì…ë‹ˆë‹¤.
    # ë”°ë¼ì„œ í•„ìˆ˜ ëª©ë¡ì—ì„œ :phoneì„ ì œì™¸í•˜ì—¬, ë¯¸ì…ë ¥ ì‹œì—ë„ ì ‘ìˆ˜ë˜ë„ë¡ í•©ë‹ˆë‹¤.
    required_params = [:translation_type, :name, :company, :email, :content]
    missing_params = required_params.select { |param| params[param].blank? }

    if missing_params.any?
      flash[:error] = "í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”: #{missing_params.join(', ')}"
      redirect_to contact_path and return
    end

    # ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
    unless params[:email].match?(/\A[\w+\-.]+@[a-z\d\-]+(\.[a-z\d\-]+)*\.[a-z]+\z/i)
      flash[:error] = "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
      redirect_to contact_path and return
    end

    # íŒŒì¼ ì²¨ë¶€ ì²˜ë¦¬ (ì„ íƒì‚¬í•­)
    # í¼ì˜ íŒŒì¼ í•„ë“œ ë„¤ì„ì€ `:files` (ë‹¤ì¤‘ íŒŒì¼ ì§€ì›)
    attachment_files = params[:files]
    
    # ì‹¤ì œ íŒŒì¼ì´ ì²¨ë¶€ëœ ê²½ìš°ë§Œ í•„í„°ë§ (ë¹ˆ ë¬¸ìì—´ ì œì™¸)
    valid_files = attachment_files&.reject { |file| file.blank? || file.is_a?(String) }
    has_attachments = valid_files&.any?

    begin
      # ë²ˆì—­ ìš”ì²­ ë©”ì¼ ë°œì†¡
      # íŒŒì¼ ì²¨ë¶€ê°€ ìˆìœ¼ë©´ ë™ê¸° ì²˜ë¦¬ (ActiveJob ì§ë ¬í™” ë¬¸ì œ íšŒí”¼)
      # íŒŒì¼ì´ ì—†ìœ¼ë©´ ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ë¹ ë¥¸ ì‘ë‹µ
      begin
        mailer = TranslationMailer.send_translation_request(
          translation_type: params[:translation_type],
          name: params[:name],
          company: params[:company],
          phone: params[:phone],
          email: params[:email],
          content: params[:content],
          attachment: valid_files
        )
        
        if has_attachments
          # íŒŒì¼ ì²¨ë¶€ê°€ ìˆëŠ” ê²½ìš° ë™ê¸° ë°œì†¡
          mailer.deliver_now
        else
          # íŒŒì¼ì´ ì—†ëŠ” ê²½ìš° ë¹„ë™ê¸° ë°œì†¡
          mailer.deliver_later
        end

        # 2025-08-21: ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¥¸ ì„±ê³µ ë©”ì‹œì§€ ë¬¸êµ¬ ë³€ê²½ (í•œ ì¤„ ë°”ê¿ˆ í¬í•¨)
        flash[:success] = "ìš”ì²­ì´ ë°œì†¡ ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¼ë°˜, ê±°ë˜ì´ìœ  í†µì§€ì„œ ë²ˆì—­ì€ 3ì‹œê°„ ì´ë‚´ ë‚©í’ˆ ì²˜ë¦¬ë˜ë©°, ê¸´ê¸‰ ë²ˆì—­ì€ ë²ˆì—­ì´ ì‹œì‘ë˜ëŠ” ì¦‰ì‹œ í™•ì¸ ì•ˆë‚´ ìœ ì„  ì—°ë½ì„ ë“œë¦¬ê² ìŠµë‹ˆë‹¤."
      rescue Net::ReadTimeout => e
        # 2025-08-21: SMTP ReadTimeoutì€ ë„¤íŠ¸ì›Œí¬/ì„œë²„ ì‘ë‹µ ì§€ì—°ìœ¼ë¡œ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë©°,
        #   ì‹¤ì œ SMTP ì„œë²„ì—ì„œ ë°œì†¡ì´ ì§„í–‰ë˜ì–´ ìˆ˜ì‹ ë˜ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤.
        #   ì‚¬ìš©ì ê²½í—˜ì„ ìœ„í•´ ì„±ê³µ ì•ˆë‚´ë¥¼ í‘œì‹œí•˜ë˜, ë‚´ë¶€ì—ëŠ” ê²½ê³  ë¡œê·¸ë¥¼ ë‚¨ê¹ë‹ˆë‹¤.
        Rails.logger.warn "Translation request email timed out (read timeout), delivery may still succeed: #{e.message}"
        # ReadTimeout ìƒí™©ì—ì„œë„ ì‚¬ìš©ì ê²½í—˜ì„ ìœ„í•´ ë™ì¼í•œ ì„±ê³µ ì•ˆë‚´ ë¬¸êµ¬ ì‚¬ìš©
        flash[:success] = "ìš”ì²­ì´ ë°œì†¡ ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¼ë°˜, ê±°ë˜ì´ìœ  í†µì§€ì„œ ë²ˆì—­ì€ 3ì‹œê°„ ì´ë‚´ ë‚©í’ˆ ì²˜ë¦¬ë˜ë©°, ê¸´ê¸‰ ë²ˆì—­ì€ ë²ˆì—­ì´ ì‹œì‘ë˜ëŠ” ì¦‰ì‹œ í™•ì¸ ì•ˆë‚´ ìœ ì„  ì—°ë½ì„ ë“œë¦¬ê² ìŠµë‹ˆë‹¤."
      rescue => e
        # ê¸°íƒ€ ì˜ˆì™¸ëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ì˜¤ë¥˜ë¡œ ì•ˆë‚´í•©ë‹ˆë‹¤. (ë¦¬í„´ê°’/í”Œë¡œìš° ë³€ê²½ ì—†ìŒ)
        Rails.logger.error "Translation request email failed: #{e.message}"
        flash[:error] = "ë©”ì¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."
      end

      redirect_to contact_path
    end
  end
end
